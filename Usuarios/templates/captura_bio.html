<!DOCTYPE html>
<html lang="en">
<head>
        <!-- 
    Documento implementado por Luis Angel Hernández
    Página para capturar datos biométricos mediante la cámara del dispositivo.
    
    Este documento contiene:
    - Estilos para el diseño de la interfaz.
    - Lógica en JavaScript para la activación de la cámara y envío de imágenes.
    
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura Biométrica</title>
    <style>
               /*
        Estilos implementados por Luis Angel Hernández
        Diseñan la página para mostrar un video de la cámara,
        un botón de captura y un indicador de carga.
        
        - body: Define la tipografía y el alineado del contenido.
        - #video: Ajusta el tamaño del video para dispositivos.
        - #capture-btn: Estiliza el botón de captura.
        - #loader: Muestra un mensaje de carga.
        */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #video {
            width: 100%;
            max-width: 600px;
            margin: 10px 0;
        }
        #capture-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        #capture-btn:hover {
            background-color: #0056b3;
        }
        #loader {
            font-size: 18px;
            color: #007bff;
            display: none;
        }
    </style>
</head>
<body>
        <!-- 
    Elementos principales de la página:
    - Un título que indica la función de la página.
    - Un video para mostrar la vista previa de la cámara.
    - Un botón para capturar la imagen.
    - Un indicador de carga que aparece durante el procesamiento.
    -->
    <h2>Captura Biométrica</h2>
    <video id="video" autoplay playsinline muted></video>
    <br>
    <button id="capture-btn">Capturar</button>
    <div id="loader">Procesando...</div>

    <script>
                /*
        Script implementado por Luis Angel Hernández
        Lógica en JavaScript para gestionar la cámara y el envío de imágenes al servidor.
        */
        const video = document.getElementById("video");
        const captureBtn = document.getElementById("capture-btn");
        const loader = document.getElementById("loader");

               /**
         * Obtiene el token desde la URL y valida su presencia.
         *
         * Esta función extrae el token requerido para la operación desde los parámetros
         * de la URL. Si no se encuentra, muestra un mensaje de error y redirige al usuario
         * a la página principal.
         */
        const token = new URLSearchParams(window.location.search).get("token");
        if (!token) {
            alert("Token no válido. Verifica que estés accediendo desde el QR generado.");
            window.location.href = "/"; // Redirige a la página principal
        }

                /**
         * Activa la cámara del dispositivo.
         *
         * Esta función solicita permisos para usar la cámara mediante getUserMedia.
         * Si el usuario acepta, muestra el video en el elemento HTML correspondiente.
         *
         * Args:
         *     None.
         *
         * Returns:
         *     None.
         */
        function activarCamara() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(error => {
                    console.error("Error al activar la cámara:", error);
                    alert("No se pudo activar la cámara. Verifica los permisos o usa otro dispositivo.");
                });
        }

               /**
         * Captura una imagen desde la cámara y la envía al servidor.
         *
         * Este evento se activa al hacer clic en el botón de captura. La función toma
         * un fotograma del video, lo convierte en base64 y lo envía al servidor para
         * su procesamiento, usando un token para autenticación.
         *
         * Args:
         *     None.
         *
         * Returns:
         *     None.
         */
        captureBtn.addEventListener("click", () => {
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext("2d");
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
            const imageData = canvas.toDataURL("image/png");
        
            if (!imageData || imageData.length < 100) {
                alert("Error al capturar la imagen. Inténtalo de nuevo.");
                return;
            }

            // Mostrar el indicador de carga
            loader.style.display = "block";

            // Manejo de timeout para la solicitud
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // Timeout de 10 segundos

            // Enviar la imagen al servidor con el token
            fetch("{% url 'get_temp_image' %}?token=" + token, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ image: imageData }),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId); // Limpiar el timeout si hay respuesta
                return response.json();
            })
            .then(data => {
                loader.style.display = "none"; // Ocultar el indicador de carga
                if (data.success) {
                    alert("Imagen capturada y enviada correctamente.");
                    window.close(); // Cierra la ventana del celular
                } else {
                    alert("Error al guardar la imagen: " + data.message);
                }
            })
            .catch(error => {
                loader.style.display = "none"; // Ocultar el indicador de carga
                if (error.name === "AbortError") {
                    alert("El proceso tomó demasiado tiempo. Intenta nuevamente.");
                } else {
                    console.error("Error al enviar la imagen al servidor:", error);
                    alert("No se pudo enviar la imagen al servidor.");
                }
            });
        });

        // Activar la cámara al cargar la página
        activarCamara();
    </script>
</body>
</html>
