{% extends 'base.html' %}
{% load static %}

{% block title %} Regístrate {% endblock title %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/registro_cliente.css' %}">
{% endblock css %}

{% block content %}

<section class="register-container">
    <form method="POST" enctype="multipart/form-data" class="register-form" id="registerForm">
        {% csrf_token %}
        <h2>Regístrate como cliente</h2>

        {{ form.as_p }}

        <div class="form-check">
            <input type="checkbox" id="terminosCheckbox" name="terminos" class="form-check-input" required>
            <label class="form-check-label" for="terminosCheckbox">
                Acepto <a href="#" data-bs-toggle="modal" data-bs-target="#terminosModal">términos de servicio</a>
            </label>
        </div>
        
        <div class="form-check">
            <input type="checkbox" id="privacidadCheckbox" name="privacidad" class="form-check-input" required>
            <label class="form-check-label" for="privacidadCheckbox">
                Acepto <a href="#" data-bs-toggle="modal" data-bs-target="#privacidadModal">políticas de privacidad</a>
            </label>
        </div>

        <label for="fotoRostro">Captura de Rostro:</label>
        <input type="hidden" id="fotoRostro" name="foto_rostro">
        <button type="button" onclick="activarCamara()" class="register-btn" id="activarCamaraBtn">Activar cámara</button>

        <button type="submit" class="register-btn" style="margin-top: 20px;">Registrarse</button>

        <label>¿Ya tienes una cuenta? <a href="{% url 'inicio_sesion' %}">Da clic aquí</a></label>

        {% load socialaccount %}
        {% providers_media_js %}

        <div class="social-register">
            <div class="social-btn">
                <a href="{% provider_login_url 'google' %}" class="google-btn">
                    <img src="{% static 'images/google_logo.png' %}" alt="Google logo" class="google-logo">
                    Registrarse con Google
                </a>
            </div>
        </div>
        <label>¿Deseas publicar tus servicios? <a href="{% url 'registro_proveedor' %}">Registrarse como proveedor aquí</a></label>
    </form>
</section>

<!-- Modal para la cámara -->
<div id="cameraModal" class="modalCamara">
    <div class="modalCamara-content">
        <h3>Captura tu rostro</h3>
        <video id="video" autoplay playsinline></video>
        <div class="modal-buttons">
            <button type="button" onclick="capturarFoto()" class="register-btn">Capturar Foto</button>
            <button type="button" onclick="cerrarModal()" class="register-btn">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal para aviso de dispositivo sin cámara -->
<div id="noCameraModal" class="modalCamara">
    <div class="modalCamara-content">
        <h3>Registro Obligatorio con Cámara</h3>
        <p>No se detectó una cámara en este dispositivo o el acceso a la cámara fue denegado. Para completar el registro, escanea el siguiente código QR desde un dispositivo con cámara.</p>
        <div id="qrCode"></div>
        <div class="modal-buttons">
            <button type="button" onclick="cerrarNoCameraModal()" class="register-btn">Cerrar</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script> <!-- Librería para generar QR -->
  <!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ENjdO4Dr2bkBIFxQpeo1qjma/l2tw5r7zQpSgyGnv/x4pI0yAZCQDR0iI12QfQfI" crossorigin="anonymous">

<script>
    const video = document.getElementById("video");
    const cameraModal = document.getElementById("cameraModal");
    const noCameraModal = document.getElementById("noCameraModal");
    const fotoRostroInput = document.getElementById("fotoRostro");

        /**
     * Verifica periódicamente si una imagen temporal está disponible en el servidor.
     * 
     * Realiza solicitudes GET a un endpoint para comprobar si existe una imagen capturada
     * desde otro dispositivo. Si la encuentra, la sincroniza con el campo oculto del formulario.
     * 
     * @returns {void}
     */

    document.addEventListener("DOMContentLoaded", () => {
        const fotoRostroInput = document.getElementById("fotoRostro");
        //Vacia el contenido del input de la foto del rostro que devuelve el form en caso de error
        document.getElementById("id_foto_rostro").value = '';
        const qrToken = "{{ qr_token }}"; // Token generado en la vista
        const qrUrl = "{{ qr_url }}"; // Usa la URL generada desde el backend

        
        function verificarImagenTemporal() {
            fetch("{% url 'get_temp_image' %}?token=" + qrToken, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Error al recuperar la imagen. Estado: " + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.image_base64) {
                    // Sincronizar la imagen con el campo fotoRostro
                    fotoRostroInput.value = data.image_base64;
                    console.log("Imagen sincronizada correctamente:", data.image_base64);
                    alert("Imagen sincronizada correctamente. Ya puedes completar el registro.");
                    clearInterval(verificacionInterval); // Detener la verificación
                } else {
                    console.log("No se encontró una imagen temporal en el servidor. Reintentando...");
                }
            })
            .catch(error => {
                console.error("Error al recuperar la imagen del servidor:", error);
            });
        }
    
        // Verificar cada 5 segundos si la imagen está disponible
        const verificacionInterval = setInterval(verificarImagenTemporal, 5000);
    });
    
    
    /**
     * Valida que se haya capturado una foto antes de enviar el formulario.
     * 
     * Previene el envío del formulario si el campo `fotoRostro` está vacío,
     * mostrando un mensaje de advertencia al usuario.
     * 
     * @returns {void}
     */

    document.getElementById("registerForm").addEventListener("submit", (e) => {
        const fotoRostroInput = document.getElementById("fotoRostro");
        if (!fotoRostroInput.value) {
            e.preventDefault(); // Prevenir el envío
            alert("No se ha capturado una foto. Por favor, captura una foto antes de registrarte.");
        } else {
            console.log("Foto capturada enviada al servidor:", fotoRostroInput.value);
        }
    });
    
    /**
     * Activa la cámara del dispositivo y muestra el modal para captura de rostro.
     * 
     * Utiliza la API `navigator.mediaDevices.getUserMedia` para acceder a la cámara.
     * Si se detecta un error (como la ausencia de cámara o falta de permisos),
     * muestra un modal alternativo para registro con código QR.
     * 
     * @returns {void}
     */
    
    function activarCamara() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                video.srcObject = stream;
                cameraModal.style.display = "flex";
            })
            .catch((error) => {
                console.error("Error al acceder a la cámara:", error);
                mostrarNoCameraModal();
            });
    }

        /**
     * Cierra el modal de captura de cámara y detiene el stream de video.
     * 
     * Llama a la función `detenerCamara` para liberar los recursos utilizados por
     * la cámara y oculta el modal de captura.
     * 
     * @returns {void}
     */
    function cerrarModal() {
        cameraModal.style.display = "none";
        detenerCamara();
    }

        /**
     * Detiene el stream de video activo y libera los recursos de la cámara.
     * 
     * Obtiene el stream asignado al elemento `<video>` y detiene cada una de
     * sus pistas activas (tracks). Luego, limpia el contenido del elemento `<video>`.
     * 
     * @returns {void}
     */
    function detenerCamara() {
        const stream = video.srcObject;
        if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach((track) => track.stop());
            video.srcObject = null;
        }
    }

        /**
     * Captura una imagen del video activo y la guarda en el campo oculto del formulario.
     * 
     * Crea un elemento `<canvas>` donde se dibuja el cuadro actual del video usando
     * `drawImage`. Convierte el contenido del lienzo a una cadena Base64 (formato PNG)
     * y lo asigna al input oculto `fotoRostro` para enviarlo al servidor.
     * 
     * @returns {void}
     */
    function capturarFoto() {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const fotoCapturada = canvas.toDataURL("image/png");

        if (!fotoCapturada || fotoCapturada.length < 50) {
            alert("Error al capturar la foto. Inténtalo de nuevo.");
            return;
        }

        fotoRostroInput.value = fotoCapturada;
        alert("Foto capturada exitosamente.");
        cerrarModal();
    }
        /**
     * Muestra el modal para dispositivos sin cámara.
     * 
     * El modal incluye un mensaje indicando que la cámara no está disponible
     * y genera un código QR que redirige al usuario a un dispositivo con cámara.
     * 
     * @returns {void}
     */

    function mostrarNoCameraModal() {
        noCameraModal.style.display = "flex";

        const qrUrl = "{{ qr_url }}"; // URL dinámica desde el servidor
        generarQRCode(qrUrl);
    }

        /**
     * Cierra el modal para dispositivos sin cámara.
     * 
     * Oculta el modal mostrado previamente por `mostrarNoCameraModal`.
     * 
     * @returns {void}
     */
    function cerrarNoCameraModal() {
        noCameraModal.style.display = "none";
    }

        /**
     * Genera un código QR con una URL específica.
     * 
     * Utiliza la biblioteca `QRious` para generar un código QR dinámico y lo
     * renderiza dentro de un elemento `<canvas>` en el modal correspondiente.
     * 
     * @param {string} url - La URL que será codificada en el código QR.
     * @returns {void}
     */
    function generarQRCode(url) {
        const qrElement = document.getElementById("qrCode");
        qrElement.innerHTML = ""; // Limpia contenido previo

        new QRious({
            element: qrElement.appendChild(document.createElement("canvas")),
            value: url,
            size: 250
        });
    }
</script>

{% endblock content %}
 
