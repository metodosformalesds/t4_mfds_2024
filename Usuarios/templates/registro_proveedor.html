{% extends 'base.html' %}
{% load static %}

{% block title %} Regístrate como proveedor {% endblock title %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/registro_proveedor.css' %}">
{% endblock css %}

{% block content %}

<section class="register-container">
    <form method="POST" enctype="multipart/form-data" class="register-form" id="registerForm">
        {% csrf_token %}
        <h2>Regístrate como proveedor</h2>

        {{ form.as_p }}

        <label for="fotoRostro">Captura de Rostro:</label>
        <input type="hidden" id="fotoRostro" name="foto_rostro">
        <button type="button" onclick="activarCamara()" class="register-btn">Activar cámara</button>

        <button type="submit" class="register-btn" style="margin-top: 20px;">Registrarse</button>

        <label>¿Ya tienes una cuenta? <a href="{% url 'inicio_sesion' %}">Da clic aquí</a></label>

        {% load socialaccount %}
        {% providers_media_js %}

        <div class="social-register">
            <div class="social-btn">
                <a href="{% provider_login_url 'google' %}" class="google-btn">
                    <img src="{% static 'images/google_logo.png' %}" alt="Google logo" class="google-logo">
                    Registrarse con Google
                </a>
            </div>
        </div>

        <label>¿Deseas contratar servicios? <a href="{% url 'registro_cliente' %}">Registrarse como cliente aquí</a></label>
    </form>
</section>

<!-- Modal para la cámara -->
<div id="cameraModal" class="modal">
    <div class="modal-content">
        <h3>Captura tu rostro</h3>
        <video id="video" autoplay playsinline></video>
        <div class="modal-buttons">
            <button type="button" onclick="capturarFoto()" class="register-btn">Capturar Foto</button>
            <button type="button" onclick="cerrarModal()" class="register-btn">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal para aviso de dispositivo sin cámara -->
<div id="noCameraModal" class="modal">
    <div class="modal-content">
        <h3>Registro Obligatorio con Cámara</h3>
        <p>No se detectó una cámara en este dispositivo o el acceso a la cámara fue denegado. Para completar el registro, escanea el siguiente código QR desde un dispositivo con cámara.</p>
        <div id="qrCode"></div>
        <div class="modal-buttons">
            <button type="button" onclick="cerrarNoCameraModal()" class="register-btn">Cerrar</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
    const video = document.getElementById("video");
    const cameraModal = document.getElementById("cameraModal");
    const noCameraModal = document.getElementById("noCameraModal");
    const fotoRostroInput = document.getElementById("fotoRostro");

    document.addEventListener("DOMContentLoaded", () => {
        const qrToken = "{{ qr_token }}"; // Token generado en la vista
        const qrElement = document.getElementById("qrCode");
        const qrUrl = "{% url 'captura_bio' %}?token=" + qrToken;

        // Generar el código QR
        new QRious({
            element: qrElement.appendChild(document.createElement("canvas")),
            value: qrUrl,
            size: 250
        });

        // Sincronización automática de la imagen
        function verificarImagenTemporal() {
            fetch("{% url 'get_temp_image' %}?token=" + qrToken, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Error al recuperar la imagen. Estado: " + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.image_base64) {
                    fotoRostroInput.value = data.image_base64;
                    console.log("Imagen sincronizada correctamente:", data.image_base64);
                    alert("Imagen sincronizada correctamente. Ya puedes completar el registro.");
                    clearInterval(verificacionInterval);
                } else {
                    console.log("No se encontró una imagen temporal en el servidor. Reintentando...");
                }
            })
            .catch(error => {
                console.error("Error al recuperar la imagen del servidor:", error);
            });
        }

        const verificacionInterval = setInterval(verificarImagenTemporal, 5000); // Verificar cada 5 segundos
    });

    function activarCamara() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                video.srcObject = stream;
                cameraModal.style.display = "flex";
            })
            .catch((error) => {
                console.error("Error al acceder a la cámara:", error);
                mostrarNoCameraModal();
            });
    }

    function cerrarModal() {
        cameraModal.style.display = "none";
        detenerCamara();
    }

    function detenerCamara() {
        const stream = video.srcObject;
        if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach((track) => track.stop());
            video.srcObject = null;
        }
    }

    function capturarFoto() {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const fotoCapturada = canvas.toDataURL("image/png");

        if (!fotoCapturada || fotoCapturada.length < 50) {
            alert("Error al capturar la foto. Inténtalo de nuevo.");
            return;
        }

        fotoRostroInput.value = fotoCapturada;
        alert("Foto capturada exitosamente.");
        cerrarModal();
    }

    function mostrarNoCameraModal() {
        noCameraModal.style.display = "flex";
    }

    function cerrarNoCameraModal() {
        noCameraModal.style.display = "none";
    }
</script>

{% endblock content %}
